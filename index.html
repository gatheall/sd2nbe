<HTML>
<HEAD>
<TITLE>sd2nbe</TITLE>
<LINK REV="made" HREF="mailto:theall@tifaware.com">
<LINK REL="shortcut icon" HREF="http://www.tifaware.com/favicon.ico">
</HEAD>

<!--#include virtual="/header.html"-->
<!--#if expr="$weblint" -->
<BODY BGCOLOR="#FFFFFF">
<!--#endif -->


<H4 ALIGN="center">
   <A HREF="/">TifaWARE</A> |
   <A HREF="../">Perl Programs</A> |
   sd2nbe
</H4>
                                                                                
                                                                                
<HR>
<H2>sd2nbe</H2>

<H3>Introduction</H3>

<P>Nessus offers a optional feature known as <A
HREF="http://www.nessus.org/doc/session_saving.html">session saving</A>. 
It's intended as a means to recover results of interrupted scans (due,
for example, to a power outage or client machine crash), although it can
also be used as a more general way of saving results.  Provided that the
server was configured to support session saving and that the user
elected to save the session when submitting a scan, session data will be
saved in the directory
<CODE>${prefix}/var/nessus/users/${user}/sessions</CODE>.</P>

<P>To recover results, a user connects to the Nessus server and restores
the session.  The server then replays the session, scanning any hosts
that were missed or unfinished from before, and displays the results. 
One drawback to restoring a session, though, is the length of time the
client takes to replay it.  Even if the scan was not interrupted,
replaying the session may approach the time it took to do the scan
originally.</P>

<P><B>sd2nbe</B> takes an alternative approach -- it reads session data
directly and outputs results in a format known as <CODE>NBE</CODE>
(<CODE>Nessus BackEnd</CODE>).  While the format may not be especially
readable, its use offers several attractive features:</P>

<UL>
   <LI>It can be fed into the unix-based nessus client and converted 
      to a variety of other formats; eg, HTML, text, XML, etc (see
      nessus(1) for details).</LI>

   <LI>It can be easily filtered so as to limit reports, for example,
      to certain hosts or plugins.</LI>

   <LI>It can be merged with other NBE output simply by concatenating 
    the sources.</LI>
</UL>

<P><B>sd2nbe</B> is written in Perl.  It should work on any system with
Perl 5 or better.  It also requires the Perl modules <CODE>Carp</CODE>
and <CODE>Getopt::Long</CODE>.  If your system does not have these
modules installed already, visit <A
HREF="http://search.cpan.org/">CPAN</A> for help.</P>


<H3>Installation</H3>

<OL>
   <LI>Retrieve the script 
      <A HREF="/code/sd2nbe/sd2nbe">sd2nbe</A> and save it locally.  You 
         may also wish to verify its 
      <A HREF="/code/sd2nbe/sd2nbe.md5">MD5 checksum</A> or, better, its
      <A HREF="/code/sd2nbe/sd2nbe.asc">GPG signature</A> against
      <A HREF="/~theall/gpg.html">my current GPG key</A>.</LI>

   <LI>Verify ownership and permissions on the script - while only
      root will be able to read session data files, there's no reason
      why the script itself can't be accessed by another user.</LI>

   <LI>You may wish to edit the script to adjust the location of
      the perl interpreter in the first line.</LI>
</OL>


<H3>Use</H3>

<P>This script operates like pretty much any other filter in unix --
reading input from either the file(s) named on the commandline or STDIN
and writing output to STDOUT.  In the case of <B>sd2nbe</B>, input
should be one or more session data files, which can be found in the
directory <CODE>${prefix}/var/nessus/users/${user}/sessions</CODE>,
provided session saving is in effect.</P>

<P><B>sd2nbe</B> will also display copious debugging messages while
running if the option <CODE>-d|--debug</CODE> is used.</P>

<P>Examples:</P>

<BLOCKQUOTE>Convert a session from user 'theall' run on Jan 11 at 16:50 to NBE.
<BLOCKQUOTE><PRE>
sd2nbe /usr/local/var/nessus/users/theall/sessions/20040111-165004-data &gt; session.nbe
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Convert the same session and display debugging messages.
<BLOCKQUOTE><PRE>
sd2nbe -d /usr/local/var/nessus/users/theall/sessions/20040111-165004-data &gt; session.nbe
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<P>Examples of Manipulating Results in NBE Format:</P>

<BLOCKQUOTE>Convert results.nbe to NSR format:
<BLOCKQUOTE><PRE>
cat results.nbe | grep ^results | sed 's/^[^|]*|[^|]*|//g' &gt; results.nsr
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Convert results.nbe to HTML with pie charts:
<BLOCKQUOTE><PRE>
nessus -i results.nbe -o results.html_graph
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Filter results.nbe for one subnet and convert to XML:
<BLOCKQUOTE><PRE>
fgrep '|10.0.1.|' results.nbe &gt; subnet-10-0-1.nbe
nessus -i subnet-10-0-1.nbe -o subnet-10-0-1.xml
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Produce an HTML report from results.nbe showing only
critical / high risk vulnerabilities: [NB: only results with risk
factors of <I>Critical</I> and <I>High</I> are output, not those such as
<I>Low to High</I>.]
<BLOCKQUOTE><PRE>
egrep -i '(Risk|Risk +factor) *: *(Critical|High)' results.nbe &gt; results-high.nbe
nessus -i results-high.nbe -o results-high.html
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Create one HTML report for each host in results.nbe:
<BLOCKQUOTE><PRE>
awk -F'|' '$1 == "results" {hosts[$3]++} END {for (h in hosts) print h}' results.nbe  &gt; /tmp/hosts
if test -s /tmp/hosts; then
    for h in `cat /tmp/hosts`; do
        fgrep "|$h|" results.nbe &gt; $h.nbe
        nessus -i $h.nbe -o $h.html
        rm $h.nbe
    done
fi
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>

<BLOCKQUOTE>Extract scan results for just plugin #11921 from results.nbe
and convert to HTML. 
<BLOCKQUOTE><PRE>
awk -F'|' '$1 == "timestamps" || ($1 == "results" && $5 == "11921")' results.nbe &gt; ms03-049.nbe
nessus -i ms03-049.nbe -o ms03-049.html
</PRE></BLOCKQUOTE>
</BLOCKQUOTE>


<H3>Known Bugs and Caveats</H3>

<P>Currently, I am not aware of any bugs in this script.</P>

<P>Don't convert as a group multiple session data files that reflect
scans of the same host(s); instead, convert them one at a time.</P>

<P>Warnings are issued for hosts that were not scanned completely. 
However, the script does not check whether the scan itself is complete
(ie, all targets were tested).</P>


<H3>Copyright and License</H3>

<P>Copyright (c) 2004, George A. Theall.<BR>
All rights reserved.</P>

<P>This script is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.</P>


<H3>History</H3>

<CENTER>
<TABLE CELLPADDING="5" CELLSPACING="0" WIDTH="95%" BORDER="1">
   <TR>
      <TH ALIGN="left">Date </TH>
      <TH ALIGN="left">Version </TH>
      <TH ALIGN="left">Verification </TH>
      <TH ALIGN="left">Notes<BR></TH>
   </TR>
   <TR>
      <TH ALIGN="left" VALIGN="top">18-Oct-2004 </TH>
      <TD ALIGN="left" VALIGN="top"><A HREF="/code/sd2nbe/sd2nbe-1.0.1">1.0.1</A> </TD>
      <TD ALIGN="left" VALIGN="top"><A HREF="/code/sd2nbe/sd2nbe-1.0.1.md5">MD5</A> / 
         <A HREF="/code/sd2nbe/sd2nbe-1.0.1.asc">GPG</A> </TD>
      <TD ALIGN="left" VALIGN="top">
      <UL>
         <LI>Changed the bang-path to use <CODE>/usr/bin/perl</CODE> rather
            than <CODE>/usr/local/bin/perl</CODE>.</LI>
         <LI>Changed the usage message.</LI>
         <LI>Added code to provide help if invalid commandline arguments
            were supplied.</LI>
      </UL></TD>
   <TR>
      <TH ALIGN="left" VALIGN="top">14-Jan-2004 </TH>
      <TD ALIGN="left" VALIGN="top"><A HREF="/code/sd2nbe/sd2nbe-1.00">1.00</A> </TD>
      <TD ALIGN="left" VALIGN="top"><A HREF="/code/sd2nbe/sd2nbe-1.00.md5">MD5</A> / 
         <A HREF="/code/sd2nbe/sd2nbe-1.00.asc">GPG</A> </TD>
      <TD ALIGN="left" VALIGN="top">
      <UL>
         <LI>Initial version.</LI>
      </UL></TD>
   </TR>
</TABLE>
</CENTER>


<HR>
<H4 ALIGN="center">
   <A HREF="/">TifaWARE</A> |
   <A HREF="../">Perl Programs</A> |
   sd2nbe
</H4>
                                                                                

<!-- $Id$ -->

<!--#include virtual="/footer.html" -->
<!--#if expr="$weblint" -->
</BODY>
<!--#endif -->
</HTML>
